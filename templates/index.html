<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ContactCleaner - Apollo.io CSV Processor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #0056b3;
            background-color: #e3f2fd;
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .cleaning-option {
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .cleaning-option:hover {
            background-color: #f8f9fa;
        }
        .contact-row {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .contact-row:hover {
            background-color: #f8f9fa !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .contact-table {
            font-size: 0.9rem;
        }
        .contact-table th {
            background-color: #495057 !important;
            color: white;
            font-weight: 600;
            border: none;
            padding: 12px 8px;
        }
        .contact-table td {
            padding: 10px 8px;
            vertical-align: middle;
            border-color: #e9ecef;
        }
        .contact-name {
            font-weight: 600;
            color: #495057;
        }
        .contact-title {
            font-size: 0.85rem;
            color: #6c757d;
            font-style: italic;
        }
        .contact-email {
            color: #007bff;
            text-decoration: none;
        }
        .contact-email:hover {
            text-decoration: underline;
        }
        .contact-company {
            font-weight: 500;
            color: #28a745;
        }
        .contact-phone {
            font-family: monospace;
            font-size: 0.85rem;
        }
        .contact-location {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="text-center mb-4">
                    <h1 class="display-4 text-primary">
                        <i class="fas fa-broom"></i> ContactCleaner
                    </h1>
                    <p class="lead text-muted">Clean and process your Apollo.io contact data</p>
                </div>

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                {% if not uploaded %}
                <!-- File Upload Section -->
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h3><i class="fas fa-upload"></i> Upload CSV File</h3>
                    </div>
                    <div class="card-body">
                        <form method="POST" enctype="multipart/form-data">
                            <div class="upload-area">
                                <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                <h4>Select your Apollo.io CSV file</h4>
                                <input type="file" class="form-control mt-3" name="csv_file" accept=".csv" required>
                            </div>
                            <div class="text-center mt-3">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-upload"></i> Upload & Preview
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                {% else %}
                <!-- Data Processing Section -->
                <div class="row">
                    <div class="col-md-4">
                        <!-- File Stats -->
                        <div class="card shadow mb-4">
                            <div class="card-header bg-info text-white">
                                <h5><i class="fas fa-chart-bar"></i> File Statistics</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>File:</strong> {{ filename }}</p>
                                <p><strong>Original Rows:</strong> {{ original_shape[0] }}</p>
                                <p><strong>Columns:</strong> {{ original_shape[1] }}</p>
                                {% if cleaned %}
                                <hr>
                                <p><strong>Cleaned Rows:</strong> {{ cleaned_shape[0] }}</p>
                                <p><strong>Final Columns:</strong> {{ cleaned_shape[1] }}</p>
                                {% endif %}
                            </div>
                        </div>

                        {% if not cleaned %}
                        <!-- Cleaning Options -->
                        <div class="card shadow">
                            <div class="card-header bg-warning text-dark">
                                <h5><i class="fas fa-cogs"></i> Data Cleaning Options</h5>
                            </div>
                            <div class="card-body">
                                <form method="POST" action="/clean">
                                    <div class="cleaning-option">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="trim_whitespace" name="cleaning_options">
                                            <label class="form-check-label">
                                                <strong>Trim Whitespace</strong><br>
                                                <small class="text-muted">Remove extra spaces from all text fields</small>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="cleaning-option">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="drop_missing_names" name="cleaning_options">
                                            <label class="form-check-label">
                                                <strong>Remove Missing Names</strong><br>
                                                <small class="text-muted">Drop rows with empty First Name or Last Name</small>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="cleaning-option">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="standardize_title" name="cleaning_options">
                                            <label class="form-check-label">
                                                <strong>Standardize Titles</strong><br>
                                                <small class="text-muted">Convert titles to proper case</small>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="cleaning-option">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="remove_email_duplicates" name="cleaning_options">
                                            <label class="form-check-label">
                                                <strong>Remove Email Duplicates</strong><br>
                                                <small class="text-muted">Keep only first occurrence of each email</small>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="cleaning-option">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="remove_phone_duplicates" name="cleaning_options">
                                            <label class="form-check-label">
                                                <strong>Remove Phone Duplicates</strong><br>
                                                <small class="text-muted">Keep only first occurrence of each phone</small>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="cleaning-option">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="normalize_phones" name="cleaning_options">
                                            <label class="form-check-label">
                                                <strong>Normalize Phone Numbers</strong><br>
                                                <small class="text-muted">Convert to E.164 format</small>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="cleaning-option">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="lowercase_emails" name="cleaning_options">
                                            <label class="form-check-label">
                                                <strong>Lowercase Emails</strong><br>
                                                <small class="text-muted">Convert all emails to lowercase</small>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="cleaning-option">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="filter_columns" name="cleaning_options">
                                            <label class="form-check-label">
                                                <strong>Keep Essential Columns Only</strong><br>
                                                <small class="text-muted">First Name, Last Name, Title, Company, Email, Phone, Location</small>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="d-grid mt-3">
                                        <button type="submit" class="btn btn-warning btn-lg">
                                            <i class="fas fa-magic"></i> Clean Data
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <div class="col-md-8">
                        <!-- Data Preview -->
                        <div class="card shadow">
                            <div class="card-header {% if cleaned %}bg-success text-white{% else %}bg-secondary text-white{% endif %}">
                                <h5><i class="fas fa-table"></i> Data Preview</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover contact-table mb-0">
                                        <thead>
                                            <tr>
                                                <th><i class="fas fa-user"></i> Name</th>
                                                <th><i class="fas fa-briefcase"></i> Title</th>
                                                <th><i class="fas fa-building"></i> Company</th>
                                                <th><i class="fas fa-envelope"></i> Email</th>
                                                <th><i class="fas fa-phone"></i> Phone</th>
                                                <th><i class="fas fa-map-marker-alt"></i> Location</th>
                                                <th><i class="fas fa-eye"></i> Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for index, row in preview_df.iterrows() %}
                                            <tr class="contact-row" data-row-index="{{ index }}">
                                                <td>
                                                    <div class="contact-name">
                                                        {{ (row.get('First Name', '') + ' ' + row.get('Last Name', '')).strip() or 'N/A' }}
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="contact-title">
                                                        {{ row.get('Title', '') if row.get('Title') and row.get('Title') != 'nan' else 'N/A' }}
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="contact-company">
                                                        {{ row.get('Company', '') if row.get('Company') and row.get('Company') != 'nan' else 'N/A' }}
                                                    </div>
                                                </td>
                                                <td>
                                                    {% if row.get('Email') and row.get('Email') != 'nan' %}
                                                    <a href="mailto:{{ row.get('Email') }}" class="contact-email">
                                                        {{ row.get('Email') }}
                                                    </a>
                                                    {% else %}
                                                    <span class="text-muted">N/A</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div class="contact-phone">
                                                        {% set phone_found = false %}
                                                        {% for col in columns %}
                                                            {% if 'phone' in col.lower() and row.get(col) and row.get(col) != 'nan' and not phone_found %}
                                                                {{ row.get(col) }}
                                                                {% set phone_found = true %}
                                                            {% endif %}
                                                        {% endfor %}
                                                        {% if not phone_found %}
                                                            <span class="text-muted">N/A</span>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="contact-location">
                                                        {% set location_parts = [] %}
                                                        {% if row.get('City') and row.get('City') != 'nan' %}
                                                            {% set _ = location_parts.append(row.get('City')) %}
                                                        {% endif %}
                                                        {% if row.get('State') and row.get('State') != 'nan' %}
                                                            {% set _ = location_parts.append(row.get('State')) %}
                                                        {% endif %}
                                                        {% if row.get('Country') and row.get('Country') != 'nan' %}
                                                            {% set _ = location_parts.append(row.get('Country')) %}
                                                        {% endif %}
                                                        {{ ', '.join(location_parts) if location_parts else 'N/A' }}
                                                    </div>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary view-contact-btn" data-contact-index="{{ index }}">
                                                        <i class="fas fa-eye"></i> View
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="card-footer">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i> 
                                        Showing first 10 rows of {{ original_shape[0] if not cleaned else cleaned_shape[0] }} total rows
                                        <span class="text-primary">â€¢ Click on any row to view full contact details</span>
                                    </small>
                                </div>
                            </div>
                        </div>

                        {% if cleaned %}
                        <!-- Download Section -->
                        <div class="card shadow mt-4">
                            <div class="card-header bg-success text-white">
                                <h5><i class="fas fa-download"></i> Download Cleaned Data</h5>
                            </div>
                            <div class="card-body">
                                <p>Data cleaning completed successfully!</p>
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <a href="/download" class="btn btn-success btn-lg me-md-2">
                                        <i class="fas fa-download"></i> Download Clean CSV
                                    </a>
                                    <a href="/reset" class="btn btn-outline-secondary btn-lg">
                                        <i class="fas fa-redo"></i> Start Over
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                {% if not cleaned %}
                <div class="text-center mt-4">
                    <a href="/reset" class="btn btn-outline-secondary">
                        <i class="fas fa-redo"></i> Start Over
                    </a>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Contact Details Modal -->
    <div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="contactModalLabel">
                        <i class="fas fa-user-circle"></i> Contact Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="contactModalBody">
                    <!-- Contact details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Close
                    </button>
                    <button type="button" class="btn btn-primary" onclick="copyContactInfo()">
                        <i class="fas fa-copy"></i> Copy Info
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    {% if uploaded %}
    <!-- Contact Data (Generated by Jinja2) -->
    <script type="application/json" id="contact-data">
    [
        {% for index, row in preview_df.iterrows() %}
        {
            "index": {{ index }},
            {% for column in columns %}
            "{{ column }}": {{ row.get(column)|tojson if row.get(column) is not none else 'null' }}{% if not loop.last %},{% endif %}
            {% endfor %}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
    </script>
    {% endif %}
    
    <script>
        // Store contact data for JavaScript access
        let contactData = [];
        let currentContact = null;
        
        function showContactDetails(rowIndex) {
            const contact = contactData.find(c => c.index === rowIndex);
            if (!contact) {
                alert('Contact data not found');
                return;
            }

            // Store current contact for copy functionality
            currentContact = contact;

            const modalBody = document.getElementById('contactModalBody');
            const modalTitle = document.getElementById('contactModalLabel');
            
            // Update modal title
            const fullName = `${contact['First Name'] || ''} ${contact['Last Name'] || ''}`.trim() || 'Unknown Contact';
            modalTitle.innerHTML = `<i class="fas fa-user-circle"></i> ${fullName}`;

            // Create contact details HTML
            let detailsHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-0 bg-light h-100">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-user"></i> Personal Information</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>First Name:</strong> ${contact['First Name'] || 'N/A'}</p>
                                <p><strong>Last Name:</strong> ${contact['Last Name'] || 'N/A'}</p>
                                <p><strong>Title:</strong> ${contact['Title'] || 'N/A'}</p>
                                <p><strong>Email:</strong> 
                                    ${contact['Email'] && contact['Email'] !== 'nan' ? 
                                        `<a href="mailto:${contact['Email']}" class="text-primary">${contact['Email']}</a>` : 'N/A'}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 bg-light h-100">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-building"></i> Company Information</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Company:</strong> ${contact['Company'] || 'N/A'}</p>
                                <p><strong>Industry:</strong> ${contact['Industry'] || 'N/A'}</p>
                                <p><strong>Employees:</strong> ${contact['# Employees'] || 'N/A'}</p>
                                <p><strong>Website:</strong> 
                                    ${contact['Website'] && contact['Website'] !== 'nan' ? 
                                        `<a href="${contact['Website']}" target="_blank" class="text-success">${contact['Website']}</a>` : 'N/A'}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card border-0 bg-light h-100">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-phone"></i> Contact Information</h6>
                            </div>
                            <div class="card-body">
            `;

            // Add phone numbers
            const phoneFields = ['Work Direct Phone', 'Mobile Phone', 'Corporate Phone', 'Home Phone', 'Other Phone'];
            phoneFields.forEach(field => {
                if (contact[field] && contact[field] !== 'nan') {
                    detailsHTML += `<p><strong>${field}:</strong> <span class="font-monospace">${contact[field]}</span></p>`;
                }
            });

            detailsHTML += `
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 bg-light h-100">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-map-marker-alt"></i> Location Information</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>City:</strong> ${contact['City'] || 'N/A'}</p>
                                <p><strong>State:</strong> ${contact['State'] || 'N/A'}</p>
                                <p><strong>Country:</strong> ${contact['Country'] || 'N/A'}</p>
                                <p><strong>Company Address:</strong> ${contact['Company Address'] || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add additional fields if they exist
            const additionalFields = ['LinkedIn Url', 'Company Linkedin Url', 'Seniority', 'Departments'];
            let hasAdditionalFields = additionalFields.some(field => contact[field] && contact[field] !== 'nan');
            
            if (hasAdditionalFields) {
                detailsHTML += `
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card border-0 bg-light">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> Additional Information</h6>
                                </div>
                                <div class="card-body">
                `;

                additionalFields.forEach(field => {
                    if (contact[field] && contact[field] !== 'nan') {
                        if (field.includes('Linkedin') || field.includes('Url')) {
                            detailsHTML += `<p><strong>${field}:</strong> <a href="${contact[field]}" target="_blank" class="text-primary">${contact[field]}</a></p>`;
                        } else {
                            detailsHTML += `<p><strong>${field}:</strong> ${contact[field]}</p>`;
                        }
                    }
                });

                detailsHTML += `
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            modalBody.innerHTML = detailsHTML;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('contactModal'));
            modal.show();
        }

        function copyContactInfo() {
            if (!currentContact) {
                alert('No contact selected');
                return;
            }
            
            let contactText = `Name: ${currentContact['First Name'] || ''} ${currentContact['Last Name'] || ''}\n`;
            contactText += `Title: ${currentContact['Title'] || 'N/A'}\n`;
            contactText += `Company: ${currentContact['Company'] || 'N/A'}\n`;
            contactText += `Email: ${currentContact['Email'] || 'N/A'}\n`;
            
            // Add phone if available
            const phoneFields = ['Work Direct Phone', 'Mobile Phone', 'Corporate Phone'];
            for (const field of phoneFields) {
                if (currentContact[field] && currentContact[field] !== 'nan') {
                    contactText += `Phone: ${currentContact[field]}\n`;
                    break;
                }
            }
            
            // Add location if available
            const locationParts = [];
            ['City', 'State', 'Country'].forEach(field => {
                if (currentContact[field] && currentContact[field] !== 'nan') {
                    locationParts.push(currentContact[field]);
                }
            });
            if (locationParts.length > 0) {
                contactText += `Location: ${locationParts.join(', ')}\n`;
            }
            
            navigator.clipboard.writeText(contactText).then(() => {
                alert('Contact information copied to clipboard!');
            }).catch(() => {
                alert('Could not copy to clipboard');
            });
        }

        // Initialize event listeners
        function initializeEventListeners() {
            // Add click event to table rows
            const rows = document.querySelectorAll('.contact-row');
            rows.forEach(row => {
                row.addEventListener('click', function(e) {
                    // Don't trigger if clicking on a button or link
                    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || e.target.closest('button')) {
                        return;
                    }
                    const rowIndex = parseInt(this.dataset.rowIndex);
                    showContactDetails(rowIndex);
                });
            });

            // Add click event to view buttons
            const viewButtons = document.querySelectorAll('.view-contact-btn');
            viewButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent row click
                    const contactIndex = parseInt(this.dataset.contactIndex);
                    showContactDetails(contactIndex);
                });
            });
        }

        // Enhanced DOMContentLoaded event
        document.addEventListener('DOMContentLoaded', function() {
            // Load contact data from JSON script tag
            const dataScript = document.getElementById('contact-data');
            if (dataScript) {
                try {
                    contactData = JSON.parse(dataScript.textContent);
                } catch (e) {
                    console.error('Error parsing contact data:', e);
                }
            }
            
            // Initialize event listeners
            initializeEventListeners();
        });
    </script>
</body>
</html> 